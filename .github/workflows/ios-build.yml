name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app
        run: npm run build
      
      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli
      
      - name: Initialize Capacitor (if needed)
        run: |
          if [ ! -f "capacitor.config.json" ] && [ ! -f "capacitor.config.ts" ]; then
            echo "Capacitor not initialized, but config file exists - continuing"
          fi
      
      - name: Add iOS platform (if not exists)
        run: |
          if [ ! -d "ios" ]; then
            echo "Adding iOS platform..."
            npx cap add ios
          else
            echo "iOS platform already exists"
          fi
          # Verify Podfile exists
          if [ ! -f "ios/App/Podfile" ] && [ ! -f "ios/Podfile" ]; then
            echo "Warning: Podfile not found after adding iOS platform"
            echo "Attempting to re-add iOS platform..."
            rm -rf ios
            npx cap add ios
          fi
      
      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods
      
      - name: Sync Capacitor
        run: |
          echo "Syncing Capacitor iOS platform..."
          npx cap sync ios || {
            echo "Sync failed, checking iOS project structure..."
            ls -la ios/ || echo "ios directory doesn't exist"
            if [ -d "ios/App" ]; then
              ls -la ios/App/ || echo "Cannot list ios/App contents"
              if [ -f "ios/App/Podfile" ]; then
                echo "Podfile exists, attempting manual pod install..."
                cd ios/App
                pod install
                cd ../..
              else
                echo "Podfile not found at ios/App/Podfile"
                find ios -name "Podfile" 2>/dev/null || echo "No Podfile found anywhere"
              fi
            fi
            exit 1
          }
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Build iOS app
        run: |
          cd ios/App
          mkdir -p build
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/App.xcarchive \
            archive
          # Verify archive was created
          if [ ! -d "build/App.xcarchive" ]; then
            echo "ERROR: Archive was not created at build/App.xcarchive"
            echo "Contents of build directory:"
            ls -la build/ || echo "build directory doesn't exist"
            exit 1
          fi
          echo "Archive created successfully at build/App.xcarchive"
      
      - name: Create ExportOptions.plist if needed
        run: |
          if [ ! -f "ios/App/ExportOptions.plist" ]; then
            mkdir -p ios/App
            cat > ios/App/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>development</string>
          	<key>teamID</key>
          	<string></string>
          	<key>signingStyle</key>
          	<string>automatic</string>
          	<key>compileBitcode</key>
          	<false/>
          </dict>
          </plist>
          EOF
          fi
      
      - name: Verify archive exists before export
        run: |
          if [ ! -d "ios/App/build/App.xcarchive" ]; then
            echo "ERROR: Archive not found at ios/App/build/App.xcarchive"
            echo "Searching for archive files..."
            find ios -name "*.xcarchive" -type d 2>/dev/null || echo "No .xcarchive files found"
            echo "Contents of ios/App/build:"
            ls -la ios/App/build/ 2>/dev/null || echo "ios/App/build directory doesn't exist"
            exit 1
          fi
          echo "Archive found, proceeding with export..."
      
      - name: Export IPA
        run: |
          mkdir -p ios/App/build/export
          xcodebuild -exportArchive \
            -archivePath ios/App/build/App.xcarchive \
            -exportPath ios/App/build/export \
            -exportOptionsPlist ios/App/ExportOptions.plist
          # Verify IPA was created
          echo "Checking for exported IPA..."
          ls -lh ios/App/build/export/*.ipa || echo "IPA file not found in export directory"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios/App/build/export/*.ipa


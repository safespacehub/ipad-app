name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build web app
        run: |
          npm run build
          # Verify dist directory was created
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory was not created by build"
            exit 1
          fi
          echo "✅ Web app built successfully"
          echo "Dist directory contents:"
          ls -la dist/ | head -10
      
      - name: Install Capacitor CLI
        run: |
          npm install -g @capacitor/cli
          echo "Capacitor CLI version:"
          npx cap --version
      
      - name: Verify Capacitor configuration
        run: |
          echo "Checking Capacitor configuration..."
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.json" ]; then
            echo "ERROR: Capacitor config file not found"
            echo "Looking for config files:"
            ls -la capacitor.config.* 2>/dev/null || echo "No capacitor config files found"
            exit 1
          fi
          echo "✅ Capacitor config found"
          if [ -f "capacitor.config.ts" ]; then
            echo "Using capacitor.config.ts"
            cat capacitor.config.ts
          fi
      
      - name: Add iOS platform (if not exists)
        run: |
          echo "Checking for iOS platform..."
          if [ ! -d "ios" ]; then
            echo "iOS directory doesn't exist, adding platform..."
            echo "Current directory: $(pwd)"
            echo "Checking Capacitor config..."
            ls -la capacitor.config.* 2>/dev/null || echo "No capacitor config found"
            echo "Checking dist directory..."
            ls -la dist/ 2>/dev/null || echo "dist directory doesn't exist"
            npx cap add ios || {
              echo "Failed to add iOS platform"
              echo "Capacitor version:"
              npx cap --version || echo "Cannot get Capacitor version"
              exit 1
            }
            echo "iOS platform added, checking structure..."
            ls -la ios/ || echo "ios directory still doesn't exist"
          else
            echo "iOS platform already exists"
            echo "Contents of ios directory:"
            ls -la ios/
          fi
          # Capacitor 8 uses Swift Package Manager, not CocoaPods
          # Check for Package.swift or Podfile (for older versions)
          echo "Checking for iOS project files..."
          if [ -f "ios/App/Package.swift" ]; then
            echo "✅ Package.swift found (Capacitor 8 - Swift Package Manager)"
          elif [ -f "ios/App/Podfile" ]; then
            echo "✅ Podfile found (older Capacitor version - CocoaPods)"
          elif [ -f "ios/Podfile" ]; then
            echo "✅ Podfile found at ios/Podfile (older Capacitor version)"
          else
            echo "⚠️  Neither Package.swift nor Podfile found"
            echo "Searching for project files:"
            find ios -name "Package.swift" 2>/dev/null || echo "No Package.swift found"
            find ios -name "Podfile" 2>/dev/null || echo "No Podfile found"
            echo "Contents of ios/App:"
            ls -la ios/App/ 2>/dev/null || echo "ios/App doesn't exist"
            # For Capacitor 8, Package.swift might be optional or in a different location
            # Check if we have the Xcode project at least
            if [ -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
              echo "✅ Xcode project found, continuing (Capacitor 8 may not need Package.swift)"
            else
              echo "❌ Xcode project not found either"
              echo "Attempting to re-add iOS platform..."
              rm -rf ios
              npx cap add ios || {
                echo "Failed to re-add iOS platform"
                exit 1
              }
              # Check again after re-adding
              if [ -f "ios/App/Package.swift" ] || [ -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
                echo "✅ iOS project structure found after re-adding"
              else
                echo "❌ iOS project structure still not found after re-adding"
                exit 1
              fi
            fi
          fi
      
      - name: Install CocoaPods (only if needed)
        run: |
          # Capacitor 8 uses Swift Package Manager, so CocoaPods is only needed for older versions
          if [ -f "ios/App/Podfile" ] || [ -f "ios/Podfile" ]; then
            echo "Podfile found, installing CocoaPods..."
            sudo gem install cocoapods
          else
            echo "No Podfile found - using Swift Package Manager (Capacitor 8)"
          fi
      
      - name: Sync Capacitor
        run: |
          echo "Syncing Capacitor iOS platform..."
          npx cap sync ios || {
            echo "Sync failed, checking iOS project structure..."
            ls -la ios/ || echo "ios directory doesn't exist"
            if [ -d "ios/App" ]; then
              ls -la ios/App/ || echo "Cannot list ios/App contents"
              # Only run pod install if Podfile exists (older Capacitor versions)
              if [ -f "ios/App/Podfile" ] || [ -f "ios/Podfile" ]; then
                echo "Podfile exists, attempting manual pod install..."
                cd ios/App
                pod install
                cd ../..
              else
                echo "No Podfile found - using Swift Package Manager"
                echo "Checking for Package.swift:"
                find ios -name "Package.swift" 2>/dev/null || echo "No Package.swift found"
              fi
            fi
            exit 1
          }
      
      - name: Verify iOS project structure
        run: |
          echo "Verifying iOS project structure..."
          if [ ! -d "ios/App" ]; then
            echo "ERROR: ios/App directory doesn't exist"
            exit 1
          fi
          echo "Checking for required files..."
          # Capacitor 8 uses Swift Package Manager, not CocoaPods
          if [ -f "ios/App/Podfile" ]; then
            echo "✅ Podfile found (older Capacitor version)"
            # For CocoaPods, we need the workspace
            if [ ! -f "ios/App/App.xcworkspace/contents.xcworkspacedata" ]; then
              echo "WARNING: App.xcworkspace not found, running pod install..."
              cd ios/App
              pod install || {
                echo "pod install failed"
                echo "Contents of ios/App:"
                ls -la
                exit 1
              }
              cd ../..
            fi
          elif [ -f "ios/App/Package.swift" ]; then
            echo "✅ Package.swift found (Capacitor 8 - Swift Package Manager)"
            # For Swift Package Manager, we use the .xcodeproj directly, not .xcworkspace
            if [ ! -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
              echo "ERROR: App.xcodeproj not found"
              exit 1
            fi
          else
            echo "⚠️  Neither Podfile nor Package.swift found"
            echo "Checking for Xcode project..."
            if [ -f "ios/App/App.xcodeproj/project.pbxproj" ]; then
              echo "✅ Xcode project found, continuing"
            else
              echo "ERROR: No Xcode project found"
              echo "Contents of ios/App:"
              ls -la ios/App/
              exit 1
            fi
          fi
          echo "✅ iOS project structure verified"
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Set up code signing settings
        run: |
          cd ios/App
          # Check if using workspace or project
          if [ -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            XCODE_BUILD_ARG="-workspace App.xcworkspace"
          else
            XCODE_BUILD_ARG="-project App.xcodeproj"
          fi
          # Disable code signing for development builds
          xcodebuild $XCODE_BUILD_ARG \
            -scheme App \
            -configuration Release \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            -showBuildSettings | grep -i "code_sign" || echo "Code signing settings applied"
          # Also update the project file directly to disable signing
          if [ -f "App.xcodeproj/project.pbxproj" ]; then
            echo "Updating project file to disable code signing..."
            # Use sed to disable code signing in project file
            sed -i '' 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' App.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i 's/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = "";/g' App.xcodeproj/project.pbxproj 2>/dev/null || true
            sed -i '' 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g' App.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i 's/CODE_SIGN_IDENTITY = .*/CODE_SIGN_IDENTITY = "";/g' App.xcodeproj/project.pbxproj 2>/dev/null || true
            sed -i '' 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' App.xcodeproj/project.pbxproj 2>/dev/null || \
            sed -i 's/CODE_SIGN_STYLE = Automatic/CODE_SIGN_STYLE = Manual/g' App.xcodeproj/project.pbxproj 2>/dev/null || true
          fi
          cd ../..
      
      - name: Build iOS app
        run: |
          cd ios/App
          # Check if we're using CocoaPods (workspace) or Swift Package Manager (project)
          if [ -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "✅ Using CocoaPods workspace"
            WORKSPACE_ARG="-workspace App.xcworkspace"
          elif [ -f "App.xcodeproj/project.pbxproj" ]; then
            echo "✅ Using Swift Package Manager project"
            WORKSPACE_ARG="-project App.xcodeproj"
          else
            echo "ERROR: Neither workspace nor project found in ios/App/"
            echo "Current directory: $(pwd)"
            echo "Contents:"
            ls -la
            echo "Searching for workspace/project:"
            find . -name "*.xcworkspace" -type d 2>/dev/null || echo "No workspace found"
            find . -name "*.xcodeproj" -type d 2>/dev/null || echo "No project found"
            exit 1
          fi
          echo "Proceeding with build..."
          mkdir -p build
          xcodebuild $WORKSPACE_ARG \
            -scheme App \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/App.xcarchive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            DEVELOPMENT_TEAM="" \
            archive
          # Verify archive was created
          if [ ! -d "build/App.xcarchive" ]; then
            echo "ERROR: Archive was not created at build/App.xcarchive"
            echo "Contents of build directory:"
            ls -la build/ || echo "build directory doesn't exist"
            exit 1
          fi
          echo "Archive created successfully at build/App.xcarchive"
      
      - name: Create ExportOptions.plist if needed
        run: |
          if [ ! -f "ios/App/ExportOptions.plist" ]; then
            mkdir -p ios/App
            cat > ios/App/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>development</string>
          	<key>teamID</key>
          	<string></string>
          	<key>signingStyle</key>
          	<string>automatic</string>
          	<key>compileBitcode</key>
          	<false/>
          </dict>
          </plist>
          EOF
          fi
      
      - name: Verify archive exists before export
        run: |
          if [ ! -d "ios/App/build/App.xcarchive" ]; then
            echo "ERROR: Archive not found at ios/App/build/App.xcarchive"
            echo "Searching for archive files..."
            find ios -name "*.xcarchive" -type d 2>/dev/null || echo "No .xcarchive files found"
            echo "Contents of ios/App/build:"
            ls -la ios/App/build/ 2>/dev/null || echo "ios/App/build directory doesn't exist"
            exit 1
          fi
          echo "Archive found, proceeding with export..."
      
      - name: Export IPA
        run: |
          mkdir -p ios/App/build/export
          xcodebuild -exportArchive \
            -archivePath ios/App/build/App.xcarchive \
            -exportPath ios/App/build/export \
            -exportOptionsPlist ios/App/ExportOptions.plist
          # Verify IPA was created
          echo "Checking for exported IPA..."
          ls -lh ios/App/build/export/*.ipa || echo "IPA file not found in export directory"
      
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app
          path: ios/App/build/export/*.ipa


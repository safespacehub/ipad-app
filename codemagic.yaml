workflows:
  ios-workflow:
    name: iOS Build Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - app_store_credentials
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
      xcode: latest
      node: 22
    scripts:
      - name: Install dependencies
        script: |
          npm ci
      - name: Build web app
        script: |
          npm run build
          # Verify dist directory was created
          if [ ! -d "dist" ]; then
            echo "ERROR: dist directory was not created by build"
            exit 1
          fi
          echo "✅ Web app built successfully"
          echo "Dist directory contents:"
          ls -la dist/ | head -10
      - name: Install Capacitor CLI
        script: |
          npm install -g @capacitor/cli
          echo "Capacitor CLI version:"
          npx cap --version
      - name: Verify Capacitor configuration
        script: |
          echo "Checking Capacitor configuration..."
          if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.json" ]; then
            echo "ERROR: Capacitor config file not found"
            echo "Looking for config files:"
            ls -la capacitor.config.* 2>/dev/null || echo "No capacitor config files found"
            exit 1
          fi
          echo "✅ Capacitor config found"
          if [ -f "capacitor.config.ts" ]; then
            echo "Using capacitor.config.ts"
            cat capacitor.config.ts
          fi
      - name: Add iOS platform (if not exists)
        script: |
          echo "Checking for iOS platform..."
          if [ ! -d "ios" ]; then
            echo "iOS directory doesn't exist, adding platform..."
            echo "Current directory: $(pwd)"
            echo "Checking Capacitor config..."
            ls -la capacitor.config.* 2>/dev/null || echo "No capacitor config found"
            echo "Checking dist directory..."
            ls -la dist/ 2>/dev/null || echo "dist directory doesn't exist"
            npx cap add ios || {
              echo "Failed to add iOS platform"
              echo "Capacitor version:"
              npx cap --version || echo "Cannot get Capacitor version"
              exit 1
            }
            echo "iOS platform added, checking structure..."
            ls -la ios/ || echo "ios directory still doesn't exist"
          else
            echo "iOS platform already exists"
            echo "Contents of ios directory:"
            ls -la ios/
          fi
          # Check for Podfile in multiple possible locations
          echo "Checking for Podfile..."
          if [ -f "ios/App/Podfile" ]; then
            echo "✅ Podfile found at ios/App/Podfile"
          elif [ -f "ios/Podfile" ]; then
            echo "✅ Podfile found at ios/Podfile"
          else
            echo "❌ Podfile not found in expected locations"
            echo "Searching for Podfile:"
            find ios -name "Podfile" 2>/dev/null || echo "No Podfile found anywhere"
            echo "Contents of ios directory:"
            ls -la ios/ || echo "ios directory doesn't exist"
            if [ -d "ios" ]; then
              echo "Contents of ios subdirectories:"
              find ios -type d -maxdepth 2 | head -20
            fi
            echo "Attempting to re-add iOS platform..."
            rm -rf ios
            npx cap add ios || {
              echo "Failed to re-add iOS platform"
              exit 1
            }
            # Check again after re-adding
            if [ -f "ios/App/Podfile" ]; then
              echo "✅ Podfile found after re-adding"
            elif [ -f "ios/Podfile" ]; then
              echo "✅ Podfile found at ios/Podfile after re-adding"
            else
              echo "❌ Podfile still not found after re-adding"
              echo "This indicates a problem with Capacitor iOS platform initialization"
              exit 1
            fi
          fi
      - name: Install CocoaPods (if needed)
        script: |
          which pod || gem install cocoapods
      - name: Sync Capacitor
        script: |
          echo "Syncing Capacitor iOS platform..."
          npx cap sync ios || {
            echo "Sync failed, checking iOS project structure..."
            ls -la ios/ || echo "ios directory doesn't exist"
            if [ -d "ios/App" ]; then
              ls -la ios/App/ || echo "Cannot list ios/App contents"
              if [ -f "ios/App/Podfile" ]; then
                echo "Podfile exists, attempting manual pod install..."
                cd ios/App
                pod install
                cd ../..
              else
                echo "Podfile not found at ios/App/Podfile"
                find ios -name "Podfile" 2>/dev/null || echo "No Podfile found anywhere"
              fi
            fi
            exit 1
          }
      - name: Verify iOS project structure
        script: |
          echo "Verifying iOS project structure..."
          if [ ! -d "ios/App" ]; then
            echo "ERROR: ios/App directory doesn't exist"
            exit 1
          fi
          echo "Checking for required files..."
          if [ ! -f "ios/App/Podfile" ]; then
            echo "ERROR: Podfile not found at ios/App/Podfile"
            exit 1
          fi
          if [ ! -f "ios/App/App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "WARNING: App.xcworkspace not found, running pod install..."
            cd ios/App
            pod install || {
              echo "pod install failed"
              echo "Contents of ios/App:"
              ls -la
              exit 1
            }
            cd ../..
          fi
          if [ ! -f "ios/App/App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "ERROR: App.xcworkspace still not found after pod install"
            echo "Contents of ios/App:"
            ls -la ios/App/
            echo "Searching for workspace files:"
            find ios -name "*.xcworkspace" -type d 2>/dev/null || echo "No workspace files found"
            exit 1
          fi
          echo "✅ iOS project structure verified"
          echo "Workspace found at: ios/App/App.xcworkspace"
      - name: Set up code signing settings on Xcode project
        script: |
          xcodebuild -project ios/App/App.xcodeproj \
            -scheme App \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      - name: Build ipa for distribution
        script: |
          cd ios/App
          # Verify workspace exists
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "ERROR: App.xcworkspace not found in ios/App/"
            echo "Current directory: $(pwd)"
            echo "Contents:"
            ls -la
            echo "Searching for workspace:"
            find . -name "*.xcworkspace" -type d 2>/dev/null || echo "No workspace found"
            exit 1
          fi
          echo "✅ Workspace found, proceeding with build..."
          mkdir -p build
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/App.xcarchive \
            archive
          # Verify archive was created
          if [ ! -d "build/App.xcarchive" ]; then
            echo "ERROR: Archive was not created at build/App.xcarchive"
            echo "Contents of build directory:"
            ls -la build/ || echo "build directory doesn't exist"
            exit 1
          fi
          echo "Archive created successfully at build/App.xcarchive"
      - name: Create ExportOptions.plist if needed
        script: |
          if [ ! -f "ios/App/ExportOptions.plist" ]; then
            mkdir -p ios/App
            cat > ios/App/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
          	<key>method</key>
          	<string>development</string>
          	<key>teamID</key>
          	<string></string>
          	<key>signingStyle</key>
          	<string>automatic</string>
          	<key>compileBitcode</key>
          	<false/>
          </dict>
          </plist>
          EOF
          fi
      - name: Verify archive exists before export
        script: |
          if [ ! -d "ios/App/build/App.xcarchive" ]; then
            echo "ERROR: Archive not found at ios/App/build/App.xcarchive"
            echo "Searching for archive files..."
            find ios -name "*.xcarchive" -type d 2>/dev/null || echo "No .xcarchive files found"
            echo "Contents of ios/App/build:"
            ls -la ios/App/build/ 2>/dev/null || echo "ios/App/build directory doesn't exist"
            exit 1
          fi
          echo "Archive found, proceeding with export..."
      - name: Export IPA
        script: |
          mkdir -p ios/App/build/export
          xcodebuild -exportArchive \
            -archivePath ios/App/build/App.xcarchive \
            -exportPath ios/App/build/export \
            -exportOptionsPlist ios/App/ExportOptions.plist
          # Verify IPA was created
          if [ ! -f "ios/App/build/export/*.ipa" ]; then
            echo "WARNING: IPA file may not have been created"
            echo "Contents of export directory:"
            ls -la ios/App/build/export/ || echo "export directory is empty or doesn't exist"
          else
            echo "IPA exported successfully"
            ls -lh ios/App/build/export/*.ipa
          fi
    artifacts:
      - ios/App/build/export/*.ipa
    publishing:
      email:
        recipients:
          - user@example.com
        notify:
          success: true
          failure: false

